/***
 * Clash Verge Rev å…¨å±€æ‰©å±•è„šæœ¬ï¼ˆæ‡’äººé…ç½®ï¼‰/ Mihomo Party è¦†å†™è„šæœ¬
 * åŸºäºé‚£å¸…å“¥çš„æ”¹çš„ï¼Œé“¾æ¥åˆ äº†å¿˜äº†ï¼Œæœ‰ç©ºå†è¡¥
 */

/**
 * æ•´ä¸ªè„šæœ¬çš„æ€»å¼€å…³ï¼Œåœ¨Mihomo Partyä½¿ç”¨çš„è¯ï¼Œè¯·ä¿æŒä¸ºtrue
 * true = å¯ç”¨
 * false = ç¦ç”¨
 */
// ============================= Section 1: æ€»å¼€å…³ =============================
const enable = true

/**
 * åˆ†æµè§„åˆ™é…ç½®ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„ç­–ç•¥ç»„
 * è®¾ç½®çš„æ—¶å€™å¯éµå¾ªâ€œæœ€å°ï¼Œå¯ç”¨â€åŸåˆ™ï¼ŒæŠŠè‡ªå·±ä¸éœ€è¦çš„è§„åˆ™å…¨ç¦ç”¨æ‰ï¼Œæé«˜æ•ˆç‡
 * true = å¯ç”¨
 * false = ç¦ç”¨
 */
// ======================= Section 2: è§„åˆ™å¼€å…³ï¼ˆæœ€å°å¯ç”¨ä¼˜å…ˆï¼‰ =======================
// é€é¡¹å¯ç”¨/å…³é—­å„åœºæ™¯ç­–ç•¥ç»„ï¼Œä¿æŒé»˜è®¤å³ä¸ºâ€œæœ€å°å¯ç”¨â€ã€‚
const ruleOptions = {
  apple: true,         // è‹¹æœæœåŠ¡
  microsoft: true,     // å¾®è½¯æœåŠ¡
  github: true,        // GithubæœåŠ¡
  google: true,        // GoogleæœåŠ¡
  openai: true,        // å›½å¤–AIå’ŒGPT
  spotify: false,      // Spotify
  youtube: true,       // YouTube
  bahamut: false,      // å·´å“ˆå§†ç‰¹/åŠ¨ç”»ç–¯
  netflix: false,      // Netflixç½‘é£
  tiktok: false,       // å›½é™…ç‰ˆæŠ–éŸ³
  disney: false,       // è¿ªå£«å°¼
  pixiv: false,        // Pixiv
  hbo: false,          // HBO
  biliintl: false,     // å“”å“©å“”å“©ä¸œå—äºš
  tvb: false,          // TVB
  hulu: false,         // Hulu
  primevideo: false,   // äºšé©¬é€Šprime video
  telegram: false,     // Telegramé€šè®¯è½¯ä»¶
  line: false,         // Lineé€šè®¯è½¯ä»¶
  whatsapp: false,     // Whatsapp
  games: false,        // æ¸¸æˆç­–ç•¥ç»„
  japan: false,        // æ—¥æœ¬ç½‘ç«™ç­–ç•¥ç»„
  tracker: true,       // ç½‘ç»œåˆ†æå’Œè·Ÿè¸ªæœåŠ¡
  ads: true,           // å¸¸è§çš„ç½‘ç»œå¹¿å‘Š
}

/**
 * åœ°åŒºé…ç½®ï¼Œé€šè¿‡regexåŒ¹é…ä»£ç†èŠ‚ç‚¹åç§°
 * regexä¼šæœ‰ä¸€å®šæ¦‚ç‡è¯¯åˆ¤ï¼Œè‡ªå·±è°ƒæ•´ä¸€ä¸‹å§
 * excludeHighPercentageæ˜¯æ’é™¤é«˜å€ç‡èŠ‚ç‚¹çš„å¼€å…³ï¼Œåªå¯¹åœ°åŒºåˆ†ç»„æœ‰æ•ˆ
 * å€ç‡å¤§äºregionsé‡Œçš„ratioLimitå€¼çš„ä»£ç†èŠ‚ç‚¹ä¼šè¢«æ’é™¤
 */
// ============================ Section 3: åœ°åŒºåˆ†ç»„ ============================
// é€šè¿‡èŠ‚ç‚¹å‘½ååŒ¹é…åœ°åŒºä¸å€ç‡é™åˆ¶ï¼Œè‡ªåŠ¨ç”Ÿæˆ url-test ç»„ã€‚
const regionOptions = {
  excludeHighPercentage: false,
  regions: [
    {
      name: 'é¦™æ¸¯',
      regex: /æ¸¯|ğŸ‡­ğŸ‡°|hk|hongkong|hong kong/i,
      ratioLimit: 2,
      icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Hong_Kong.png',
    },
    {
      name: 'ç¾å›½',
      regex: /ç¾|ğŸ‡ºğŸ‡¸|us|united state|america/i,
      ratioLimit: 2,
      icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/United_States.png',
    },
    {
      name: 'æ—¥æœ¬',
      regex: /æ—¥æœ¬|ğŸ‡¯ğŸ‡µ|jp|japan/i,
      ratioLimit: 2,
      icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Japan.png',
    },
    {
      name: 'éŸ©å›½',
      regex: /éŸ©|ğŸ‡°ğŸ‡·|kr|korea/i,
      ratioLimit: 2,
      icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Korea.png',
    },
    {
      name: 'æ–°åŠ å¡',
      regex: /æ–°åŠ å¡|ğŸ‡¸ğŸ‡¬|sg|singapore/i,
      ratioLimit: 2,
      icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Singapore.png',
    },
    {
      name: 'ä¸­å›½å¤§é™†',
      regex: /ä¸­å›½|ğŸ‡¨ğŸ‡³|cn|china/i,
      ratioLimit: 2,
      icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/China_Map.png',
    },
    {
      name: 'å°æ¹¾çœ',
      regex: /å°æ¹¾|ğŸ‡¹ğŸ‡¼|tw|taiwan|tai wan/i,
      ratioLimit: 2,
      icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/China.png',
    },
    {
      name: 'è‹±å›½',
      regex: /è‹±|ğŸ‡¬ğŸ‡§|uk|united kingdom|great britain/i,
      ratioLimit: 2,
      icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/United_Kingdom.png',
    },
    {
      name: 'å¾·å›½',
      regex: /å¾·å›½|ğŸ‡©ğŸ‡ª|de|germany/i,
      ratioLimit: 2,
      icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Germany.png',
    },
    {
      name: 'é©¬æ¥è¥¿äºš',
      regex: /é©¬æ¥|ğŸ‡²ğŸ‡¾|my|malaysia/i,
      ratioLimit: 2,
      icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Malaysia.png',
    },
    {
      name: 'åœŸè€³å…¶',
      regex: /åœŸè€³å…¶|ğŸ‡¹ğŸ‡·|tr|turkey/i,
      ratioLimit: 2,
      icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Turkey.png',
    },
  ],
}

/**
 * å…¶å®ä¸¤ç»„DNSå°±å¤Ÿäº†ï¼Œä¸€ç»„å›½å†…ï¼Œä¸€ç»„å›½å¤–
 * defaultDNSæ˜¯ç”¨æ¥è§£æDNSçš„ï¼Œå¿…é¡»ä¸ºIP
 * DNSæœ€å¥½ä¸è¦è¶…è¿‡ä¸¤ä¸ªï¼Œä»ä¸šç•ŒæŸçŸ¥åAPPçš„æ–‡æ¡£é‡Œå­¦çš„
 */
// ============================== Section 4: DNS ===============================
// é»˜è®¤å›½å¤–ä¸Šæ¸¸ä¸ºä¸»ï¼Œå¯¹å›½å†…åŸŸåå›æµåˆ°å›½å†… DNSã€‚ä¿æŒç®€æ´ã€ç¨³å®šã€‚
const defaultDNS = ['tls://223.5.5.5']

const chinaDNS = ['119.29.29.29', '223.5.5.5']

const foreignDNS = ['https://120.53.53.53/dns-query', 'https://223.5.5.5/dns-query']

/**
 * DNSç›¸å…³é…ç½®
 */
const dnsConfig = {
  enable: true,
  listen: ':1053',
  ipv6: true,
  'prefer-h3': true,
  'use-hosts': true,
  'use-system-hosts': true,
  'respect-rules': true,
  'enhanced-mode': 'fake-ip',
  'fake-ip-range': '198.18.0.1/16',
  'fake-ip-filter': ['*', '+.lan', '+.local', '+.market.xiaomi.com'],
  // 'default-nameserver': [...defaultDNS],
  nameserver: [...foreignDNS],
  'proxy-server-nameserver': [...foreignDNS],
  /**
   * è¿™é‡Œå¯¹åŸŸåè§£æè¿›è¡Œåˆ†æµ
   * ç”±äºé»˜è®¤dnsæ˜¯å›½å¤–çš„äº†ï¼Œåªéœ€è¦æŠŠå›½å†…ipå’ŒåŸŸååˆ†æµåˆ°å›½å†…dns
   */
  'nameserver-policy': {
    'geosite:private': 'system',
    'geosite:cn,steam@cn,category-games@cn,microsoft@cn,apple@cn': chinaDNS,
  },
}

// å¯é€‰ï¼šæ‰©å±•æ›´å¤šå›½å†…åŸŸåçš„ DNS åˆ†æµï¼ˆé»˜è®¤å…³é—­ä»¥ä¿æŒâ€œæœ€å°å¯ç”¨â€ï¼‰
const extendChinaDnsPolicy = true
const extraChinaPolicy = {
  // ç¤ºä¾‹ï¼šå¸¸è§å›½å†…åª’ä½“ç±»ï¼ˆæŒ‰éœ€å¼€å¯ï¼‰
  // 'geosite:category-media@cn': chinaDNS,
}
if (extendChinaDnsPolicy) {
  dnsConfig['nameserver-policy'] = {
    ...dnsConfig['nameserver-policy'],
    ...extraChinaPolicy,
  }
}

// ======================== Section 5: é€šç”¨ä¸åŸºç¡€é…ç½® =========================
// è§„åˆ™é›†é€šç”¨é…ç½®
const ruleProviderCommon = {
  type: 'http',
  format: 'yaml',
  interval: 86400,
}

// ä»£ç†ç»„é€šç”¨é…ç½®
const groupBaseOption = {
  interval: 300,
  timeout: 3000,
  url: 'http://cp.cloudflare.com/generate_204',
  lazy: true,
  'max-failed-times': 3,
  hidden: false,
}

// å€ç‡æå–è§„åˆ™å¯é…ç½®ï¼Œä¾¿äºé€‚é…ä¸åŒæœºåœºå‘½åçº¦å®š
const multiplierRegex = /(?<=[xXâœ•âœ–â¨‰å€ç‡])([1-9]+(\.\d+)*|0{1}\.\d+)(?=[xXâœ•âœ–â¨‰å€ç‡])*/i

// å·¥å…·ï¼šå»é‡ï¼ˆä¿æŒé¡ºåºï¼‰
function uniqueList(list) {
  const seen = new Set()
  const result = []
  for (const item of list) {
    if (item == null) continue
    if (!seen.has(item)) {
      seen.add(item)
      result.push(item)
    }
  }
  return result
}

// å·¥å…·ï¼šæ ¹æ®è¶…æ—¶åŠ¨æ€ç»™å‡º url-test å®¹å·®ï¼Œé™ä½æŠ–åŠ¨æ—¶çš„é¢‘ç¹åˆ‡æ¢
function getTolerance() {
  const baseTimeout = Number(groupBaseOption?.timeout ?? 3000)
  const candidate = Math.floor(baseTimeout / 30) // 3000ms -> 100
  return Math.max(50, Math.min(200, candidate))
}

// ç»Ÿä¸€ç®¡ç†æœåŠ¡å…ƒæ•°æ®ï¼ˆæ¢æµ‹ URL ä¸å›¾æ ‡ï¼‰ï¼Œä¾¿äºåç»­ç»´æŠ¤
const serviceMeta = {
  'é»˜è®¤èŠ‚ç‚¹':   { icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Proxy.png' },
  'å›½å¤–AI':     { url: 'https://chat.openai.com/cdn-cgi/trace', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/ChatGPT.png' },
  YouTube:      { url: 'https://www.youtube.com/s/desktop/494dd881/img/favicon.ico', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/YouTube.png' },
  'å“”å“©å“”å“©ä¸œå—äºš': { url: 'https://www.bilibili.tv/', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/bilibili_3.png' },
  å·´å“ˆå§†ç‰¹:     { url: 'https://ani.gamer.com.tw/ajax/getdeviceid.php', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Bahamut.png' },
  'Disney+':    { url: 'https://disney.api.edge.bamgrid.com/devices', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Disney+.png' },
  NETFLIX:      { url: 'https://api.fast.com/netflix/speedtest/v2?https=true', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Netflix.png' },
  Tiktok:       { url: 'https://www.tiktok.com/', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/TikTok.png' },
  Spotify:      { url: 'http://spclient.wg.spotify.com/signup/public/v1/account', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Spotify.png' },
  Pixiv:        { url: 'https://www.pixiv.net/favicon.ico', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Pixiv.png' },
  HBO:          { url: 'https://www.hbo.com/favicon.ico', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/HBO.png' },
  TVB:          { url: 'https://www.tvb.com/logo_b.svg', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/TVB.png' },
  'Prime Video':{ url: 'https://m.media-amazon.com/images/G/01/digital/video/web/logo-min-remaster.png', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Prime_Video.png' },
  Hulu:         { url: 'https://auth.hulu.com/v4/web/password/authenticate', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Hulu.png' },
  Telegram:     { url: 'http://www.telegram.org/img/website_icon.svg', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Telegram.png' },
  WhatsApp:     { url: 'https://web.whatsapp.com/data/manifest.json', icon: 'https://static.whatsapp.net/rsrc.php/v3/yP/r/rYZqPCBaG70.png' },
  Line:         { url: 'https://line.me/page-data/app-data.json', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Line.png' },
  æ¸¸æˆä¸“ç”¨:     { icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Game.png' },
  è·Ÿè¸ªåˆ†æ:     { icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Reject.png' },
  å¹¿å‘Šè¿‡æ»¤:     { icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Advertising.png' },
  è‹¹æœæœåŠ¡:     { url: 'http://www.apple.com/library/test/success.html', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Apple_2.png' },
  è°·æ­ŒæœåŠ¡:     { url: 'http://www.google.com/generate_204', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Google_Search.png' },
  å¾®è½¯æœåŠ¡:     { url: 'http://www.msftconnecttest.com/connecttest.txt', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Microsoft.png' },
  Github:       { url: 'https://github.com/robots.txt', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/GitHub.png' },
  æ—¥æœ¬ç½‘ç«™:     { url: 'https://r.r10s.jp/com/img/home/logo/touch.png', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/JP.png' },
  å…¶ä»–å¤–ç½‘:     { icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Streaming!CN.png' },
  å›½å†…ç½‘ç«™:     { url: 'http://wifi.vivo.com.cn/generate_204', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/StreamingCN.png' },
  ä¸‹è½½è½¯ä»¶:     { icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Download.png' },
}

const ruleProviders = new Map()
ruleProviders.set('applications', {
  ...ruleProviderCommon,
  behavior: 'classical',
  format: 'text',
  url: 'https://fastly.jsdelivr.net/gh/DustinWin/ruleset_geodata@clash-ruleset/applications.list',
  path: './ruleset/DustinWin/applications.list',
})

// ====================== Section 6: åˆå§‹è§„åˆ™ï¼ˆåŸºç¡€ï¼‰ =======================
// å›ºå®šåŸºç¡€è§„åˆ™ï¼Œåç»­ä¼šæŒ‰ ruleOptions åŠ¨æ€è¿½åŠ ã€‚
const rules = [
  'RULE-SET,applications,ä¸‹è½½è½¯ä»¶',
  'PROCESS-NAME,SunloginClient,DIRECT',
  'PROCESS-NAME,SunloginClient.exe,DIRECT',
  // ç½‘ç›˜ç›´è¿è§„åˆ™
  'DOMAIN-SUFFIX,baidupcs.com,DIRECT',
  'DOMAIN-SUFFIX,pcs.baidu.com,DIRECT',
  'DOMAIN-SUFFIX,pan.baidu.com,DIRECT',
  'DOMAIN-SUFFIX,pan.quark.cn,DIRECT',
]

// ç¨‹åºå…¥å£
/**
 * å…¥å£ï¼šè¦†å†™ä¸æ‰©å±•é…ç½®
 *
 * æµç¨‹ï¼š
 * 1) åŸºç¡€å‚æ•°è¦†ç›–ï¼ˆæ¨¡å¼ã€DNSã€profileã€æ€§èƒ½ã€snifferã€ntpã€geodataï¼‰
 * 2) åœ°åŒºåˆ†ç»„ç”Ÿæˆï¼ˆæ­£åˆ™ + å€ç‡è¿‡æ»¤ + url-test å®¹å·®ï¼‰
 * 3) é€šç”¨ç­–ç•¥ç»„ï¼ˆé»˜è®¤ã€å›½å†…ã€å¤–ç½‘ã€ä¸‹è½½ï¼‰
 * 4) åœºæ™¯ç­–ç•¥ç»„ï¼ˆæŒ‰ ruleOptions æ¡ä»¶è¿½åŠ ï¼‰
 * 5) è§„åˆ™åˆ—è¡¨ä¸è§„åˆ™æä¾›è€…æ”¶æ•›
 *
 * @param {object} config è¾“å…¥çš„åŸå§‹é…ç½®å¯¹è±¡
 * @returns {object} å¤„ç†åçš„é…ç½®
 */
function main(config) {
  const proxyCount = config?.proxies?.length ?? 0
  const proxyProviderCount =
    typeof config?.['proxy-providers'] === 'object'
      ? Object.keys(config['proxy-providers']).length
      : 0
  if (proxyCount === 0 && proxyProviderCount === 0) {
    throw new Error('é…ç½®æ–‡ä»¶ä¸­æœªæ‰¾åˆ°ä»»ä½•ä»£ç†')
  }

  let regionProxyGroups = []
  let otherProxyGroups = (config?.proxies ?? []).map((b) => {
    return b.name
  })

  // ---- åŸºç¡€å‚æ•°è¦†ç›– ----
  config['allow-lan'] = true

  config['bind-address'] = '*'

  config['mode'] = 'rule'

  // è¦†ç›–åŸé…ç½®ä¸­DNSé…ç½®
  config['dns'] = dnsConfig

  config['profile'] = {
    'store-selected': true,
    'store-fake-ip': true,
  }

  config['unified-delay'] = true

  config['tcp-concurrent'] = true

  /**
   * è¿™ä¸ªå€¼è®¾ç½®å¤§ç‚¹èƒ½çœç”µï¼Œç¬”è®°æœ¬å’Œæ‰‹æœºéœ€è¦å…³æ³¨ä¸€ä¸‹
   */
  config['keep-alive-interval'] = 1800

  config['find-process-mode'] = 'strict'

  config['geodata-mode'] = true

  /**
   * é€‚åˆå°å†…å­˜ç¯å¢ƒï¼Œå¦‚æœåœ¨æ—è·¯ç”±é‡Œè¿è¡Œå¯ä»¥æ”¹æˆstandard
   */
  config['geodata-loader'] = 'memconservative'

  config['geo-auto-update'] = true

  config['geo-update-interval'] = 24
  config['sniffer'] = {
    enable: true,
    'force-dns-mapping': true,
    'parse-pure-ip': true,
    'override-destination': false,
    sniff: {
      TLS: { ports: [443, 8443] },
      HTTP: { ports: [80, '8080-8880'] },
      QUIC: { ports: [443, 8443] },
    },
    'force-domain': [],
    'skip-domain': ['Mijia Cloud', '+.oray.com'],
  }
  config['ntp'] = {
    enable: true,
    'write-to-system': false,
    server: 'cn.ntp.org.cn',
  }

  config['geox-url'] = {
    geoip:
      'https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geoip-lite.dat',
    geosite:
      'https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geosite.dat',
    mmdb: 'https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/country-lite.mmdb',
    asn: 'https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/GeoLite2-ASN.mmdb',
  }

  /**
   * æ€»å¼€å…³å…³é—­æ—¶ä¸å¤„ç†ç­–ç•¥ç»„
   */
  if (!enable) {
    return config
  }

  // ---- åœ°åŒºåˆ†ç»„ç”Ÿæˆï¼ˆæ­£åˆ™ + å€ç‡è¿‡æ»¤ + å®¹å·®ï¼‰ ----
  regionOptions.regions.forEach((region) => {
    /**
     * æå–å€ç‡ç¬¦åˆè¦æ±‚çš„ä»£ç†èŠ‚ç‚¹
     * åˆ¤æ–­å€ç‡æœ‰é—®é¢˜çš„è¯ï¼Œå¤§æ¦‚ç‡æ˜¯è¿™ä¸ªæ­£åˆ™çš„é—®é¢˜ï¼Œå¯ä»¥è‡ªè¡Œä¿®æ”¹
     * è‡ªå·±æ”¹æ­£åˆ™çš„è¯è®°å¾—å¿…é¡»æŠŠå€ç‡çš„numberå€¼æå–å‡ºæ¥
     */
    let proxies = config.proxies
      .filter((a) => {
        const multiplier = multiplierRegex.exec(a.name)?.[1]
        return (
          a.name.match(region.regex) &&
          parseFloat(multiplier || '0') <= region.ratioLimit
        )
      })
      .map((b) => {
        return b.name
      })

    /**
     * å¿…é¡»å†åˆ¤æ–­ä¸€ä¸‹æœ‰æ²¡æœ‰ç¬¦åˆè¦æ±‚çš„ä»£ç†èŠ‚ç‚¹
     * æ²¡æœ‰çš„è¯ï¼Œè¿™ä¸ªç­–ç•¥ç»„å°±ä¸åº”è¯¥å­˜åœ¨
     * æˆ‘å–œæ¬¢è‡ªåŠ¨é€‰æ‹©å»¶è¿Ÿæœ€ä½çš„èŠ‚ç‚¹ï¼Œå–œæ¬¢è½®è¯¢çš„å¯ä»¥è‡ªå·±ä¿®æ”¹
     */
    if (proxies.length > 0) {
      regionProxyGroups.push({
        ...groupBaseOption,
        name: region.name,
        type: 'url-test',
        tolerance: getTolerance(),
        icon: region.icon,
        proxies: proxies,
      })
    }

    otherProxyGroups = otherProxyGroups.filter((x) => !proxies.includes(x))
  })

  const proxyGroupsRegionNames = regionProxyGroups.map((value) => {
    return value.name
  })

  if (otherProxyGroups.length > 0) {
    proxyGroupsRegionNames.push('å…¶ä»–èŠ‚ç‚¹')
  }

  // ---- é€šç”¨ç­–ç•¥ç»„ï¼ˆé»˜è®¤ï¼‰ ----
config['proxy-groups'] = [
  {
    ...groupBaseOption,
    name: 'é»˜è®¤èŠ‚ç‚¹',
    type: 'select',
    proxies: uniqueList(['é¦™æ¸¯', ...proxyGroupsRegionNames, 'ç›´è¿']),
    icon: serviceMeta['é»˜è®¤èŠ‚ç‚¹'].icon,
  },
  {
    ...groupBaseOption,
    name: 'è‡ªåŠ¨æµ‹é€Ÿ',
    type: 'url-test',
    proxies: uniqueList(proxyGroupsRegionNames), // åªæµ‹é€Ÿåœ°åŒºèŠ‚ç‚¹
    url: 'http://www.gstatic.com/generate_204',
    interval: 300,
    tolerance: 50,
    icon: 'https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Speedtest.png', // æµ‹é€Ÿä»ªå›¾æ ‡
  },
]


  config.proxies = config?.proxies || []
  if (!config.proxies.find((p) => p?.name === 'ç›´è¿')) {
    config.proxies.push({
      name: 'ç›´è¿',
      type: 'direct',
      udp: true,
    })
  }

  // ---- åœºæ™¯ç­–ç•¥ç»„ï¼ˆæŒ‰éœ€è¿½åŠ ï¼‰ ----
  if (ruleOptions.openai) {
    /**
     * å›½å¤– AI åœºæ™¯
     * - ç›®æ ‡ï¼šå°†å¸¸è§ AI åŸŸååˆ†æµè‡³â€œå›½å¤–AIâ€ç­–ç•¥ç»„ï¼Œå¹¶å¼•å…¥æ‰©å±•è§„åˆ™é›†
     * - è®¾è®¡ï¼šå…ˆæ·»åŠ å°‘é‡æ˜¾å¼åŸŸåï¼Œå†æŒ‚è½½å¤–éƒ¨è§„åˆ™é›†ï¼Œä¿æŒâ€œæœ€å°å¯ç”¨â€é»˜è®¤
     * - é¡ºåºï¼šè‡ªå®šä¹‰åŸŸå > å¤–éƒ¨è§„åˆ™é›†ï¼›å‘½ä¸­åä¸å†ç»§ç»­åŒ¹é…
     */
    rules.push(
      // æ˜¾å¼åŸŸåï¼ˆç¤ºä¾‹ï¼šIDE/æ’ä»¶å¢å¼ºæœåŠ¡ï¼‰
      'DOMAIN-SUFFIX,grazie.ai,å›½å¤–AI',
      'DOMAIN-SUFFIX,grazie.aws.intellij.net,å›½å¤–AI',
      // å¤–éƒ¨è§„åˆ™é›†ï¼šè¦†ç›–æ›´å¹¿çš„ AI åŸŸåæ¸…å•ï¼ˆæŒç»­æ›´æ–°ï¼‰
      'RULE-SET,ai,å›½å¤–AI',
    )
    ruleProviders.set('ai', {
      ...ruleProviderCommon,
      behavior: 'classical',
      format: 'text',
      url: 'https://github.com/dahaha-365/YaNet/raw/refs/heads/dist/rulesets/mihomo/ai.list',
      path: './ruleset/YaNet/ai.list',
    })
    config['proxy-groups'].push({
      ...groupBaseOption,
      name: 'å›½å¤–AI',
      type: 'select',
      proxies: uniqueList(['ç¾å›½', ...proxyGroupsRegionNames, 'ç›´è¿']),
      url: serviceMeta['å›½å¤–AI'].url,
      icon: serviceMeta['å›½å¤–AI'].icon,
    })
  }

  if (ruleOptions.google) {
    rules.push('GEOSITE,google,è°·æ­ŒæœåŠ¡')
    config['proxy-groups'].push({
      ...groupBaseOption,
      name: 'è°·æ­ŒæœåŠ¡',
      type: 'select',
      proxies: uniqueList(['ç¾å›½', ...proxyGroupsRegionNames, 'ç›´è¿']),
      url: serviceMeta['è°·æ­ŒæœåŠ¡'].url,
      icon: serviceMeta['è°·æ­ŒæœåŠ¡'].icon,
    })
  }

  if (ruleOptions.github) {
    rules.push('GEOSITE,github,Github')
    config['proxy-groups'].push({
      ...groupBaseOption,
      name: 'Github',
      type: 'select',
      proxies: uniqueList(['é»˜è®¤èŠ‚ç‚¹', ...proxyGroupsRegionNames, 'ç›´è¿']),
      url: serviceMeta['Github'].url,
      icon: serviceMeta['Github'].icon,
    })
  }

  if (ruleOptions.apple) {
    rules.push('GEOSITE,apple-cn,è‹¹æœæœåŠ¡')
    config['proxy-groups'].push({
      ...groupBaseOption,
      name: 'è‹¹æœæœåŠ¡',
      type: 'select',
      proxies: uniqueList(['ç›´è¿', 'é»˜è®¤èŠ‚ç‚¹', ...proxyGroupsRegionNames]),
      url: serviceMeta['è‹¹æœæœåŠ¡'].url,
      icon: serviceMeta['è‹¹æœæœåŠ¡'].icon,
    })
  }

  if (ruleOptions.microsoft) {
    rules.push('GEOSITE,microsoft@cn,å›½å†…ç½‘ç«™', 'GEOSITE,microsoft,å¾®è½¯æœåŠ¡')
    config['proxy-groups'].push({
      ...groupBaseOption,
      name: 'å¾®è½¯æœåŠ¡',
      type: 'select',
      proxies: uniqueList(['é»˜è®¤èŠ‚ç‚¹', ...proxyGroupsRegionNames, 'ç›´è¿']),
      url: serviceMeta['å¾®è½¯æœåŠ¡'].url,
      icon: serviceMeta['å¾®è½¯æœåŠ¡'].icon,
    })
  }

  if (ruleOptions.youtube) {
    rules.push('GEOSITE,youtube,YouTube')
    config['proxy-groups'].push({
      ...groupBaseOption,
      name: 'YouTube',
      type: 'select',
      proxies: uniqueList(['é»˜è®¤èŠ‚ç‚¹', ...proxyGroupsRegionNames, 'ç›´è¿']),
      url: serviceMeta['YouTube'].url,
      icon: serviceMeta['YouTube'].icon,
    })
  }

  if (ruleOptions.biliintl) {
    rules.push('GEOSITE,biliintl,å“”å“©å“”å“©ä¸œå—äºš')
    config['proxy-groups'].push({
      ...groupBaseOption,
      name: 'å“”å“©å“”å“©ä¸œå—äºš',
      type: 'select',
      proxies: uniqueList(['é»˜è®¤èŠ‚ç‚¹', 'ç›´è¿', ...proxyGroupsRegionNames]),
      url: serviceMeta['å“”å“©å“”å“©ä¸œå—äºš'].url,
      icon: serviceMeta['å“”å“©å“”å“©ä¸œå—äºš'].icon,
    })
  }

  if (ruleOptions.bahamut) {
    rules.push('GEOSITE,bahamut,å·´å“ˆå§†ç‰¹')
    config['proxy-groups'].push({
      ...groupBaseOption,
      name: 'å·´å“ˆå§†ç‰¹',
      type: 'select',
      proxies: uniqueList(['é»˜è®¤èŠ‚ç‚¹', 'ç›´è¿', ...proxyGroupsRegionNames]),
      url: serviceMeta['å·´å“ˆå§†ç‰¹'].url,
      icon: serviceMeta['å·´å“ˆå§†ç‰¹'].icon,
    })
  }

  if (ruleOptions.disney) {
    rules.push('GEOSITE,disney,Disney+')
    config['proxy-groups'].push({
      ...groupBaseOption,
      name: 'Disney+',
      type: 'select',
      proxies: uniqueList(['é»˜è®¤èŠ‚ç‚¹', ...proxyGroupsRegionNames, 'ç›´è¿']),
      url: serviceMeta['Disney+'].url,
      icon: serviceMeta['Disney+'].icon,
    })
  }

  if (ruleOptions.netflix) {
    rules.push('GEOSITE,netflix,NETFLIX')
    config['proxy-groups'].push({
      ...groupBaseOption,
      name: 'NETFLIX',
      type: 'select',
      proxies: uniqueList(['é»˜è®¤èŠ‚ç‚¹', ...proxyGroupsRegionNames, 'ç›´è¿']),
      url: serviceMeta['NETFLIX'].url,
      icon: serviceMeta['NETFLIX'].icon,
    })
  }

  if (ruleOptions.tiktok) {
    rules.push('GEOSITE,tiktok,Tiktok')
    config['proxy-groups'].push({
      ...groupBaseOption,
      name: 'Tiktok',
      type: 'select',
      proxies: uniqueList(['é»˜è®¤èŠ‚ç‚¹', ...proxyGroupsRegionNames, 'ç›´è¿']),
      url: serviceMeta['Tiktok'].url,
      icon: serviceMeta['Tiktok'].icon,
    })
  }

  if (ruleOptions.spotify) {
    rules.push('GEOSITE,spotify,Spotify')
    config['proxy-groups'].push({
      ...groupBaseOption,
      name: 'Spotify',
      type: 'select',
      proxies: uniqueList(['é»˜è®¤èŠ‚ç‚¹', ...proxyGroupsRegionNames, 'ç›´è¿']),
      url: serviceMeta['Spotify'].url,
      icon: serviceMeta['Spotify'].icon,
    })
  }

  if (ruleOptions.pixiv) {
    rules.push('GEOSITE,pixiv,Pixiv')
    config['proxy-groups'].push({
      ...groupBaseOption,
      name: 'Pixiv',
      type: 'select',
      proxies: uniqueList(['é»˜è®¤èŠ‚ç‚¹', ...proxyGroupsRegionNames, 'ç›´è¿']),
      url: serviceMeta['Pixiv'].url,
      icon: serviceMeta['Pixiv'].icon,
    })
  }

  if (ruleOptions.hbo) {
    rules.push('GEOSITE,hbo,HBO')
    config['proxy-groups'].push({
      ...groupBaseOption,
      name: 'HBO',
      type: 'select',
      proxies: uniqueList(['é»˜è®¤èŠ‚ç‚¹', ...proxyGroupsRegionNames, 'ç›´è¿']),
      url: serviceMeta['HBO'].url,
      icon: serviceMeta['HBO'].icon,
    })
  }

  if (ruleOptions.tvb) {
    rules.push('GEOSITE,tvb,TVB')
    config['proxy-groups'].push({
      ...groupBaseOption,
      name: 'TVB',
      type: 'select',
      proxies: uniqueList(['é»˜è®¤èŠ‚ç‚¹', ...proxyGroupsRegionNames, 'ç›´è¿']),
      url: serviceMeta['TVB'].url,
      icon: serviceMeta['TVB'].icon,
    })
  }

  if (ruleOptions.primevideo) {
    rules.push('GEOSITE,primevideo,Prime Video')
    config['proxy-groups'].push({
      ...groupBaseOption,
      name: 'Prime Video',
      type: 'select',
      proxies: uniqueList(['é»˜è®¤èŠ‚ç‚¹', ...proxyGroupsRegionNames, 'ç›´è¿']),
      url: serviceMeta['Prime Video'].url,
      icon: serviceMeta['Prime Video'].icon,
    })
  }

  if (ruleOptions.hulu) {
    rules.push('GEOSITE,hulu,Hulu')
    config['proxy-groups'].push({
      ...groupBaseOption,
      name: 'Hulu',
      type: 'select',
      proxies: uniqueList(['é»˜è®¤èŠ‚ç‚¹', ...proxyGroupsRegionNames, 'ç›´è¿']),
      url: serviceMeta['Hulu'].url,
      icon: serviceMeta['Hulu'].icon,
    })
  }

  if (ruleOptions.telegram) {
    rules.push('GEOIP,telegram,Telegram')
    config['proxy-groups'].push({
      ...groupBaseOption,
      name: 'Telegram',
      type: 'select',
      proxies: uniqueList(['é»˜è®¤èŠ‚ç‚¹', ...proxyGroupsRegionNames, 'ç›´è¿']),
      url: serviceMeta['Telegram'].url,
      icon: serviceMeta['Telegram'].icon,
    })
  }

  if (ruleOptions.whatsapp) {
    rules.push('GEOSITE,whatsapp,WhatsApp')
    config['proxy-groups'].push({
      ...groupBaseOption,
      name: 'WhatsApp',
      type: 'select',
      proxies: uniqueList(['é»˜è®¤èŠ‚ç‚¹', ...proxyGroupsRegionNames, 'ç›´è¿']),
      url: serviceMeta['WhatsApp'].url,
      icon: serviceMeta['WhatsApp'].icon,
    })
  }

  if (ruleOptions.line) {
    rules.push('GEOSITE,line,Line')
    config['proxy-groups'].push({
      ...groupBaseOption,
      name: 'Line',
      type: 'select',
      proxies: uniqueList(['é»˜è®¤èŠ‚ç‚¹', ...proxyGroupsRegionNames, 'ç›´è¿']),
      url: serviceMeta['Line'].url,
      icon: serviceMeta['Line'].icon,
    })
  }

  if (ruleOptions.games) {
    rules.push(
      'GEOSITE,category-games@cn,å›½å†…ç½‘ç«™',
      'GEOSITE,category-games,æ¸¸æˆä¸“ç”¨'
    )
    config['proxy-groups'].push({
      ...groupBaseOption,
      name: 'æ¸¸æˆä¸“ç”¨',
      type: 'select',
      proxies: uniqueList(['é»˜è®¤èŠ‚ç‚¹', ...proxyGroupsRegionNames, 'ç›´è¿']),
      icon: serviceMeta['æ¸¸æˆä¸“ç”¨'].icon,
    })
  }

  if (ruleOptions.tracker) {
    rules.push('GEOSITE,tracker,è·Ÿè¸ªåˆ†æ')
    config['proxy-groups'].push({
      ...groupBaseOption,
      name: 'è·Ÿè¸ªåˆ†æ',
      type: 'select',
      proxies: uniqueList(['REJECT', 'ç›´è¿', 'é»˜è®¤èŠ‚ç‚¹']),
      icon: serviceMeta['è·Ÿè¸ªåˆ†æ'].icon,
    })
  }

  if (ruleOptions.ads) {
    rules.push('GEOSITE,category-ads-all,å¹¿å‘Šè¿‡æ»¤')
    config['proxy-groups'].push({
      ...groupBaseOption,
      name: 'å¹¿å‘Šè¿‡æ»¤',
      type: 'select',
      proxies: uniqueList(['REJECT', 'ç›´è¿', 'é»˜è®¤èŠ‚ç‚¹']),
      icon: serviceMeta['å¹¿å‘Šè¿‡æ»¤'].icon,
    })
  }

  if (ruleOptions.japan) {
    rules.push(
      'RULE-SET,category-bank-jp,æ—¥æœ¬ç½‘ç«™',
      'GEOIP,jp,æ—¥æœ¬ç½‘ç«™,no-resolve'
    )
    ruleProviders.set('category-bank-jp', {
      ...ruleProviderCommon,
      behavior: 'domain',
      format: 'mrs',
      url: 'https://fastly.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@meta/geo/geosite/category-bank-jp.mrs',
      path: './ruleset/MetaCubeX/category-bank-jp.mrs',
    })
    config['proxy-groups'].push({
      ...groupBaseOption,
      name: 'æ—¥æœ¬ç½‘ç«™',
      type: 'select',
      proxies: uniqueList(['é»˜è®¤èŠ‚ç‚¹', ...proxyGroupsRegionNames, 'ç›´è¿']),
      url: serviceMeta['æ—¥æœ¬ç½‘ç«™'].url,
      icon: serviceMeta['æ—¥æœ¬ç½‘ç«™'].icon,
    })
  }

  // ---- è§„åˆ™æ”¶æ•›ä¸å…œåº• ----
  rules.push(
    'GEOSITE,private,DIRECT',
    'GEOIP,private,DIRECT,no-resolve',
    'GEOSITE,cn,å›½å†…ç½‘ç«™',
    'GEOIP,cn,å›½å†…ç½‘ç«™,no-resolve',
    'MATCH,å…¶ä»–å¤–ç½‘'
  )
  config['proxy-groups'].push(
    {
      ...groupBaseOption,
      name: 'ä¸‹è½½è½¯ä»¶',
      type: 'select',
      proxies: uniqueList(['ç›´è¿', 'REJECT', 'é»˜è®¤èŠ‚ç‚¹', 'å›½å†…ç½‘ç«™', ...proxyGroupsRegionNames]),
      icon: serviceMeta['ä¸‹è½½è½¯ä»¶'].icon,
    },
    {
      ...groupBaseOption,
      name: 'å…¶ä»–å¤–ç½‘',
      type: 'select',
      proxies: uniqueList(['é»˜è®¤èŠ‚ç‚¹', 'å›½å†…ç½‘ç«™', ...proxyGroupsRegionNames]),
      icon: serviceMeta['å…¶ä»–å¤–ç½‘'].icon,
    },
    {
      ...groupBaseOption,
      name: 'å›½å†…ç½‘ç«™',
      type: 'select',
      proxies: uniqueList(['ç›´è¿', 'é»˜è®¤èŠ‚ç‚¹', ...proxyGroupsRegionNames]),
      url: serviceMeta['å›½å†…ç½‘ç«™'].url,
      icon: serviceMeta['å›½å†…ç½‘ç«™'].icon,
    }
  )

  // ---- æ±‡æ€»ç­–ç•¥ç»„ä¸è§„åˆ™æä¾›è€… ----
  config['proxy-groups'] = config['proxy-groups'].concat(regionProxyGroups)

  // è¦†ç›–åŸé…ç½®ä¸­çš„è§„åˆ™
  config['rules'] = rules
  config['rule-providers'] = Object.fromEntries(ruleProviders)

  // ---- å…¶ä»–èŠ‚ç‚¹ï¼ˆå‰©ä½™ï¼‰ ----
  if (otherProxyGroups.length > 0) {
    config['proxy-groups'].push({
      ...groupBaseOption,
      name: 'å…¶ä»–èŠ‚ç‚¹',
      type: 'select',
      proxies: otherProxyGroups,
      icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/World_Map.png',
    })
  }
// ---- å±•ç¤ºé¡ºåºç»Ÿä¸€æ•´ç†ï¼ˆä»…å½±å“ UI æ˜¾ç¤ºé¡ºåºï¼Œä¸æ”¹åŠŸèƒ½ï¼‰ ----
(function reorderProxyGroups() {
  const order = [
    // é¡¶éƒ¨å¸¸ç”¨
    'é»˜è®¤èŠ‚ç‚¹', 'è‡ªåŠ¨æµ‹é€Ÿ',

    // ä¸šåŠ¡/åœºæ™¯ï¼ˆæŒ‰ä½ å¸¸ç”¨çš„å…ˆåæ”¾æƒ³è¦ä¼˜å…ˆæ˜¾ç¤ºçš„åå­—ï¼‰
    'å›½å¤–AI', 'è°·æ­ŒæœåŠ¡', 'å¾®è½¯æœåŠ¡', 'è‹¹æœæœåŠ¡', 'Github',
    'YouTube', 'NETFLIX', 'Disney+', 'Tiktok', 'Spotify', 'Pixiv', 'HBO', 'TVB', 'Prime Video', 'Hulu',
    'æ—¥æœ¬ç½‘ç«™', 'Telegram', 'WhatsApp', 'Line', 'æ¸¸æˆä¸“ç”¨',

    // ç³»ç»Ÿç±»
    'å›½å†…ç½‘ç«™', 'å…¶ä»–å¤–ç½‘', 'ä¸‹è½½è½¯ä»¶',

    // å…¶ä»–
    'å…¶ä»–èŠ‚ç‚¹',

    // ç½®åº•æ‹¦æˆªç±»
    'è·Ÿè¸ªåˆ†æ', 'å¹¿å‘Šè¿‡æ»¤',
  ];

  // åœ°åŒºç»„ç»Ÿä¸€å½’ç±»åˆ°â€œç³»ç»Ÿç±»â€ä¹‹åã€â€œæ‹¦æˆªç±»â€ä¹‹å‰
  const regionNameRegex = /(é¦™æ¸¯|ç¾å›½|æ—¥æœ¬|éŸ©å›½|æ–°åŠ å¡|ä¸­å›½å¤§é™†|å°æ¹¾çœ|è‹±å›½|å¾·å›½|é©¬æ¥è¥¿äºš|åœŸè€³å…¶)/;

  const anchorIdx = order.indexOf('ä¸‹è½½è½¯ä»¶'); // åœ°åŒºç»„æ˜¾ç¤ºé”šç‚¹ï¼ˆåœ¨å…¶åï¼‰
  const tailStartIdx = order.indexOf('è·Ÿè¸ªåˆ†æ'); // æ‹¦æˆªç±»å¼€å§‹ä½ç½®

  const rank = (name) => {
    const fixed = order.indexOf(name);
    if (fixed !== -1) return fixed;

    // åœ°åŒºç»„ç»Ÿä¸€æ’åœ¨ç³»ç»Ÿç±»å
    if (regionNameRegex.test(name)) return anchorIdx + 1;

    // å…¶å®ƒæœªæŒ‡å®šçš„ç­–ç•¥ç»„ï¼Œé»˜è®¤æ”¾åœ¨â€œæ‹¦æˆªç±»â€å‰ä¸€æ¡£
    return (tailStartIdx === -1 ? order.length : tailStartIdx) - 1;
  };

  if (Array.isArray(config['proxy-groups'])) {
    config['proxy-groups'].sort((a, b) => rank(a.name) - rank(b.name));
  }
})();


  // è¿”å›ä¿®æ”¹åçš„é…ç½®
  return config
}